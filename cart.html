<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cart & Checkout - Genix cool</title>
<style>
body { font-family: "Poppins", sans-serif; background: #0a0a0a; color: #f5f5f5; margin: 0; }
header { background: #000; color: gold; text-align: center; padding: 1rem; font-size: 2rem; font-weight: bold; letter-spacing: 1px; }
nav { display: flex; justify-content: center; gap: 25px; background: #111; padding: 12px 0; }
nav a { color: gold; text-decoration: none; font-weight: bold; transition: 0.3s; }
nav a:hover { color: #fff; transform: scale(1.1); }
.checkout-container { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center; padding: 2rem; }
.summary, .billing { background: #1a1a1a; border-radius: 12px; padding: 1.5rem; width: 420px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
.summary h2, .billing h2 { border-bottom: 2px solid gold; padding-bottom: 0.5rem; margin-bottom: 1rem; }
.cart-item { display: flex; justify-content: space-between; border-bottom: 1px solid #333; margin: 10px 0; padding-bottom: 10px; }
.total, .tax, .shipping { font-weight: bold; text-align: right; font-size: 1.2rem; margin-top: 10px; }
.billing label { display: block; margin: 10px 0 5px; }
.billing input, .billing select { width: 100%; padding: 10px; border-radius: 6px; border: none; margin-bottom: 10px; background: #2a2a2a; color: #fff; }
button { background: gold; color: black; border: none; padding: 12px; width: 100%; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 10px; transition: 0.3s; font-size: 1rem; }
button:hover { background: #c6a700; }
.logo { height: 40px; margin: 10px 0; }

@media(max-width: 900px) {
.checkout-container {
flex-direction: column;
align-items: center;
}
}
</style>
</head>
<body>

<header>Genix cool Checkout</header>
<nav>
<a href="index.html">Home</a>
<a href="shop.html">Shop</a>
<a href="cart.html">Cart & Checkout</a>
</nav>

<div class="checkout-container">
<div class="summary">
<h2>Order Summary</h2>
<div id="orderItems"></div>
<div class="tax">Tax (5%): ₵<span id="taxAmount">0.00</span></div>
<div class="shipping">Shipping: ₵<span id="shippingAmount">0.00</span></div>
<div class="total">Total: ₵<span id="totalAmount">0.00</span></div>
</div>

<div class="billing">
<h2>Billing & Delivery</h2>
<label>Full Name</label>
<input type="text" id="fullName" placeholder="John Doe" required>

<label>Email</label>
<input type="email" id="email" placeholder="you@example.com" required>

<label>Phone Number</label>
<input type="tel" id="phone" placeholder="+233 24 000 0000" required>

<label>Delivery Address</label>
<input type="text" id="address" placeholder="123 Main Street" required>
<input type="text" id="city" placeholder="City" required>
<input type="text" id="postalCode" placeholder="Postal Code" required>

<label>Country</label>
<select id="country" onchange="updateShipping()" required>
<option value="">Select Country</option>
<option value="Ghana">Ghana</option>
<option value="USA">USA</option>
<option value="UK">UK</option>
<option value="Canada">Canada</option>
<option value="Other">Other</option>
</select>

<label>Payment Method</label>
<select id="paymentMethod" onchange="togglePayment()">
<option value="card">Bank Card (CBG)</option>
<option value="mobile">MTN Mobile Money</option>
</select>

<div id="cardDetails">
<label>Card Number</label>
<input type="text" placeholder="1234 5678 9012 3456" id="cardNumber" maxlength="16">
<label>Expiry Date</label>
<input type="month" id="expiryDate">
<label>CVV</label>
<input type="text" placeholder="123" id="cvv" maxlength="4">
<img src="https://upload.wikimedia.org/wikipedia/commons/0/04/CBG_Bank_logo.png" alt="CBG Logo" class="logo">
</div>

<div id="mobileDetails" style="display:none;">
<label>Mobile Number</label>
<input type="tel" id="mobileNumber" placeholder="+233 24 000 0000">
<label>Transaction Reference</label>
<input type="text" id="mobileRef" placeholder="MTN MoMo Reference">
<img src="https://upload.wikimedia.org/wikipedia/commons/2/2d/MTN_Group_logo.svg" alt="MTN MoMo Logo" class="logo">
</div>

<button onclick="completePurchase()">Complete Purchase</button>
</div>
</div>

<script>
const CURRENCY_SYMBOL = "₵";
const TAX_RATE = 0.05; // 5% tax
// Adjusted shipping rates to reflect local currency (₵) and some international rates
const SHIPPING_RATES = { Ghana: 40, USA: 1500, UK: 1200, Canada: 1600, Other: 2000 }; 

let shippingCost = 0;

function togglePayment() {
const method = document.getElementById("paymentMethod").value;
document.getElementById("cardDetails").style.display = method === "card" ? "block" : "none";
document.getElementById("mobileDetails").style.display = method === "mobile" ? "block" : "none";
}

function loadOrder() {
const cart = JSON.parse(localStorage.getItem("cart")) || [];
const container = document.getElementById("orderItems");
container.innerHTML = "";
let subtotal = 0;

if(cart.length === 0) {
container.innerHTML = "<p>Your cart is empty.</p>";
} else {
cart.forEach(item => {
// FIX 1: Robust parsing: Ensure 'item.price' and 'item.quantity' are safely parsed as numbers
const price = Number(item.price);
const quantity = Number(item.quantity);

// FIX 2: Skip invalid items: If price or quantity is not a valid number, skip this item entirely.
if (isNaN(price) || isNaN(quantity) || price <= 0 || quantity <= 0) {
console.error("Invalid item data detected and skipped:", item);
return;
}

subtotal += price * quantity;
container.innerHTML += `
<div class="cart-item">
<span>${item.name} (x${quantity})</span>
<span>${CURRENCY_SYMBOL}${(price * quantity).toFixed(2)}</span>
</div>`;
});
}

updateTotals(subtotal);
}

function updateShipping() {
const country = document.getElementById("country").value;
// FIX 3: Default shipping rate check: Ensure shippingCost defaults to 0 if country is invalid or missing
shippingCost = SHIPPING_RATES[country] ?? 0;
loadOrder(); // recalc totals with new shipping
}

function updateTotals(subtotal) {
const tax = subtotal * TAX_RATE;
const total = subtotal + tax + shippingCost;
document.getElementById("taxAmount").innerText = tax.toFixed(2);
document.getElementById("shippingAmount").innerText = shippingCost.toFixed(2);
// FIX 4: Prevent negative total: Ensure total is not negative (though unlikely with price validation)
document.getElementById("totalAmount").innerText = Math.max(0, total).toFixed(2);
}

function completePurchase() {
const fullName = document.getElementById("fullName").value.trim();
const email = document.getElementById("email").value.trim();
const phone = document.getElementById("phone").value.trim();
const address = document.getElementById("address").value.trim();
const city = document.getElementById("city").value.trim();
const postalCode = document.getElementById("postalCode").value.trim();
const country = document.getElementById("country").value;
const method = document.getElementById("paymentMethod").value;

// 1. Validate basic required fields
if(!fullName || !email || !phone || !address || !city || !postalCode || !country){
alert("Please fill out all billing and delivery fields!");
return;
}

// FIX 5: Basic email validation (Client-side best practice)
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(email)) {
alert("Please enter a valid email address.");
return;
}

// 2. Validate payment-specific fields
if(method === "card") {
const cardNumber = document.getElementById("cardNumber").value.trim();
const expiryDateInput = document.getElementById("expiryDate").value; // YYYY-MM format
const cvv = document.getElementById("cvv").value.trim();

if(!cardNumber || !expiryDateInput || !cvv){
alert("Please fill out all card details!");
return;
}

// Check card number length/format (basic client-side check)
if (cardNumber.replace(/\s/g, '').length !== 16 || isNaN(Number(cardNumber.replace(/\s/g, '')))) {
alert("Please enter a valid 16-digit card number.");
return;
}

// Check for expired card date
const [expiryYear, expiryMonth] = expiryDateInput.split('-').map(Number);
const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth() + 1; 

if (expiryYear < currentYear || (expiryYear === currentYear && expiryMonth < currentMonth)) {
alert("The card expiry date is in the past. Please use a valid card.");
return;
}
} else if (method === "mobile") {
const mobileNumber = document.getElementById("mobileNumber").value.trim();
const mobileRef = document.getElementById("mobileRef").value.trim();
if(!mobileNumber || !mobileRef){
alert("Please fill out all mobile money details!");
return;
}
} 

// 3. Final Cart check (using loadOrder to check subtotal)
const cart = JSON.parse(localStorage.getItem("cart")) || [];
if(cart.length === 0){
alert("Your cart is empty! Cannot complete purchase.");
return;
}

// 4. Success simulation
alert(`✅ Payment successful!
Thank you, ${fullName}!
Total Charged: ${CURRENCY_SYMBOL}${document.getElementById("totalAmount").innerText}
Delivery to: ${address}, ${city}, ${postalCode}, ${country}
Shipping Cost: ${CURRENCY_SYMBOL}${shippingCost.toFixed(2)}`); // Ensure shippingCost is formatted

localStorage.removeItem("cart");
window.location.href = "home.html";
}

loadOrder();
</script>
</body>
</html>